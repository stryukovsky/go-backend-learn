\newpage
\begin{center}
	\textbf{\large 2. Предоставление ликвидности в Uniswap V3}
\end{center}
\refstepcounter{chapter}
\addcontentsline{toc}{chapter}{2. ПРЕДОСТАВЛЕНИЕ ЛИКВИДНОСТИ В UNISWAP V3}

\section{Концентрированная ликвидность}

Ключевым отличием Uniswap V3 от предыдущих версий является введение
концентрированной ликвидности (concentrated liquidity). В отличие от Uniswap
V2, где ликвидность распределялась равномерно по всему ценовому диапазону $(0,
	\infty)$, Uniswap V3 позволяет поставщикам ликвидности концентрировать свой
капитал в определенных ценовых интервалах.

Математически это означает, что функция торговли $\varphi$ из уравнения
\eqref{eq:trade_fn_uniswapv3} применяется не ко всему возможному ценовому
диапазону, а только к выбранному интервалу $[p_{lower}, p_{upper}]$, где
$p_{lower}$ и $p_{upper}$ -- нижняя и верхняя границы ценового диапазона
соответственно.

Для позиции с концентрированной ликвидностью в диапазоне $[p_{lower},
			p_{upper}]$ функция торговли принимает вид:

\begin{equation}
	\varphi(R, \delta, \lambda) =
	\begin{cases}
		(R_1 + \delta_1 - \lambda_1) \cdot (R_2 + \delta_2 - \lambda_2) & \text{если } p_{lower} \leq P \leq p_{upper} \\
		0                                                               & \text{иначе}
	\end{cases}
	\label{eq:concentrated_trading}
\end{equation}

где $P = \frac{R_2}{R_1}$ -- текущая цена в пуле.

\section{Тики и дискретизация ценового пространства}

Для реализации концентрированной ликвидности непрерывное ценовое пространство
разбивается на дискретные интервалы, называемые тиками (ticks). Тики
представляют собой границы между дискретными областями в ценовом пространстве.

Цена для $i$-го тика определяется как:

\begin{equation}
	P(i) = 1.0001^i
	\label{eq:tick_price}
\end{equation}

Где $i \in \mathbb{Z}$ -- индекс тика в диапазоне $[-887272, 887272]$.

Изменение цены на один тик соответствует изменению на $0.01\%$ или один
базисный пункт (basis point):

\begin{equation}
	\frac{P(i+1) - P(i)}{P(i)} = \frac{1.0001^{i+1} - 1.0001^i}{1.0001^i} = 0.0001 = 0.01\%
	\label{eq:tick_change}
\end{equation}

\subsection{Интервалы тиков}

Не каждый тик может быть инициализирован. Вместо этого каждый пул
инициализируется с шагом тиков (tick spacing), который определяет расстояние
между тиками. Шаг тиков зависит от уровня комиссии пула:

\begin{table}[h]
	\centering
	\begin{tabular}{|c|c|c|}
		\hline
		\textbf{Комиссия} & \textbf{Шаг тиков} & \textbf{Минимальное изменение цены} \\
		\hline
		0.01\%            & 1                  & 0.01\%                              \\
		0.05\%            & 10                 & 0.10\%                              \\
		0.30\%            & 60                 & 0.60\%                              \\
		1.00\%            & 200                & 2.00\%                              \\
		\hline
	\end{tabular}
	\caption{Соответствие между уровнями комиссии и интервалами тиков}
	\label{tab:tick_spacing}
\end{table}

Для данного шага тиков $ts$ только тики с индексами, кратными $ts$, могут быть
инициализированы:

\begin{equation}
	i \equiv 0 \pmod{ts}
	\label{eq:tick_divisibility}
\end{equation}

\section{Позиция поставщика ликвидности}

Позиция поставщика ликвидности в Uniswap V3 определяется тремя параметрами:

\begin{enumerate}
	\item Количество ликвидности $L \in \mathbb{R}_+$
	\item Нижняя граница $i_a \in \mathbb{Z}$ (нижний тик)
	\item Верхняя граница $i_b \in \mathbb{Z}$ (верхний тик)
\end{enumerate}

где $i_a$ и $i_b$ должны быть кратны шагу тиков $ts$: $i_a \equiv i_b \equiv 0 \pmod{ts}$.

\section{NFT-представление позиций}

В Uniswap V3 каждая позиция ликвидности представлена как невзаимозаменяемый
токен (NFT) стандарта ERC-721. Это принципиальное отличие от Uniswap V2, где
позиции представлялись взаимозаменяемыми токенами ERC-20.

NFT-представление позиций предоставляет следующие преимущества:

\begin{enumerate}
	\item \textbf{Уникальность}: Каждая позиция уникальна по своим параметрам $(L,
		      i_a, i_b)$
	\item Композируемость: Позиции могут быть интегрированы в
	      другие DeFi-протоколы
	\item \textbf{Передаваемость}: Позиции могут быть
	      переданы или проданы как самостоятельные активы
\end{enumerate}

Контракт \texttt{NonfungiblePositionManager} управляет созданием, модификацией и уничтожением позиций.

\section{Активная и неактивная ликвидность}

Важным понятием в Uniswap V3 является различие между активной и неактивной ликвидностью.

\subsection{Активная ликвидность}

Ликвидность позиции считается активной, если текущая цена $P$ находится в диапазоне позиции $[p_{lower}, p_{upper}]$:

\begin{equation}
	\text{Позиция активна} \Leftrightarrow P \in [p_{lower}, p_{upper}]
	\label{eq:active_position}
\end{equation}

Только активные позиции зарабатывают торговые комиссии.

\subsection{Изменение состава позиции}

Когда цена движется через диапазон позиции, состав активов в позиции изменяется. При движении цены вверх (токен Y дорожает относительно токена X):

\begin{itemize}
	\item Количество токена X уменьшается
	\item Количество токена Y увеличивается
	\item При $p \geq p_{upper}$ позиция полностью состоит из токена Y
\end{itemize}

Формально, при изменении цены от $P$ до $P'$ изменения в количествах токенов составляют:

\begin{equation}
	\Delta x = L \cdot \left(\frac{1}{\sqrt{P'}} - \frac{1}{\sqrt{P}}\right)
	\label{eq:delta_x}
\end{equation}

\begin{equation}
	\Delta y = L \cdot \left(\sqrt{P'} - \sqrt{P}\right)
	\label{eq:delta_y}
\end{equation}

\section{Эффективность капитала}

Концентрированная ликвидность обеспечивает значительное повышение эффективности использования капитала. В зависимости от уровня концентрации, эффективность капитала может увеличиться до 4000 раз по сравнению с Uniswap V2.

Коэффициент эффективности капитала для позиции в диапазоне $[p_{lower}, p_{upper}]$ по сравнению с полным диапазоном $(0, \infty)$ можно выразить как:

\begin{equation}
	\text{Эффективность} = \frac{L_{full}}{L_{concentrated}} = \frac{\sqrt{p_{upper}} - \sqrt{p_{lower}}}{\sqrt{p_{upper} \cdot p_{lower}}} \cdot \sqrt{p}
	\label{eq:capital_efficiency}
\end{equation}

где $L_{full}$ -- количество ликвидности, необходимое для обеспечения той же глубины рынка на полном диапазоне.

\section{Стратегии предоставления ликвидности}

\subsection{Узкий диапазон}

Стратегия узкого диапазона предполагает концентрацию ликвидности в небольшом интервале вокруг текущей цены:

\begin{equation}
	\frac{p_{upper} - p_{lower}}{p} \ll 1
	\label{eq:narrow_range}
\end{equation}

Преимущества:
\begin{itemize}
	\item Максимальная эффективность капитала
	\item Высокий доход от комиссий при активной торговле
\end{itemize}

Недостатки:
\begin{itemize}
	\item Высокий риск выхода цены из диапазона
	\item Необходимость частой ребалансировки
	\item Повышенный непостоянный убыток
\end{itemize}

\subsection{Широкий диапазон}

Стратегия широкого диапазона предполагает охват значительной части ценового пространства:

\begin{equation}
	\frac{p_{upper} - p_{lower}}{p} \gg 1
	\label{eq:wide_range}
\end{equation}

Преимущества:
\begin{itemize}
	\item Меньший риск выхода цены из диапазона
	\item Меньшая необходимость в управлении позицией
	\item Пониженный непостоянный убыток
\end{itemize}

Недостатки:
\begin{itemize}
	\item Меньшая эффективность капитала
	\item Меньший доход от комиссий на единицу капитала
\end{itemize}

\subsection{Стратегия для стейблкоинов}

Для пар стейблкоинов, таких как USDC/USDT, оптимальной является стратегия очень узкого диапазона:

\begin{equation}
	p_{lower} = 0.99, \quad p_{upper} = 1.01
	\label{eq:stablecoin_range}
\end{equation}

В паре DAI/USDC версии V2 только около 0.50\% доступного капитала использовалось для торговли в диапазоне от \$0.99 до \$1.01.

\section{Математическая модель дохода поставщика ликвидности}

Доход поставщика ликвидности в Uniswap V3 складывается из торговых комиссий и изменения стоимости активов в позиции.

\subsection{Накопление комиссий}

Комиссии накапливаются пропорционально доле ликвидности позиции в общей активной ликвидности и времени нахождения в активном состоянии:

\begin{equation}
	\text{Комиссии} = \int_{t_0}^{t_1} \frac{L_{position}}{L_{active}(t)} \cdot \text{fee}(t) \cdot V(t) \, dt
	\label{eq:fee_accumulation}
\end{equation}

где:
\begin{itemize}
	\item $L_{position}$ -- ликвидность позиции
	\item $L_{active}(t)$ -- общая активная ликвидность в момент времени $t$
	\item $\text{fee}(t)$ -- уровень комиссии
	\item $V(t)$ -- объем торгов в момент времени $t$
\end{itemize}

\subsection{Непостоянный убыток}

Концентрированные позиции могут испытывать более значительный непостоянный убыток, чем позиции V2, если цены выходят за пределы выбранного диапазона.

Для позиции в диапазоне $[p_{lower}, p_{upper}]$ при изменении цены от $p_0$ до $p_1$ (где $p_0, p_1 \in [p_{lower}, p_{upper}]$) непостоянный убыток составляет:

\begin{equation}
	IL = \frac{2\sqrt{r}}{1+r} - 1
	\label{eq:impermanent_loss}
\end{equation}

где $r = \frac{p_1}{p_0}$ -- отношение цен.

Если цена выходит за пределы диапазона, позиция полностью конвертируется в один из токенов, и непостоянный убыток может быть существенно выше.
