\newpage
\begin{center}
	\textbf{\large 1. Маркетмейкер, использующий константное произведение }
\end{center}
\refstepcounter{chapter}
\addcontentsline{toc}{chapter}{1. МАРКЕТМЕЙКЕР, ИСПОЛЬЗУЮЩИЙ КОНСТАНТНОЕ ПРОИЗВЕДЕНИЕ}

\section{Использование маркетмейкеров в децентрализованных биржах}

Изначально децентрализованные биржи представляют собой метод обмена токенами между участниками блокчейн-протокола без необходимости доверять какому-либо централизованному источнику информации о ценах, объемах торгов и прочего. На текущий момент (конец 2025 года) порядка 200 миллиардов долларов участвовало в различных протоколах децентрализованного обмена.
В общем виде, ключевым объектом децентрализованных бирж является маркетмейкер, основанный на константной функции (CFMM, constant function market makers). Успех Uniswap в свое время способствовал развитию популярности автоматизированных маркетмейкеров (AMM, automated market maker), основанных на функции константного произведения (constant product market maker). Маркет мейкер, основанный на константной функции, можно задать с помощью функции торговли $\varphi$:

\begin{equation}
	\varphi: \mathbb{R}^n_{+} \times \mathbb{R}^n_{+} \times \mathbb{R}^n_{+} \rightarrow \mathbb{R}
	\label{eq:trade_fn_general}
\end{equation}

Функция трех аргументов $\varphi$ формально задает процесс изменения состояния т.н. пула ликвидности (Liquidity Pool). Первый аргумент представляет собой вектор резервов $\mathbf{R} \subset \mathbb{R}^n_{+}$. Второй аргумент представляет собой вектор входов $\mathbf{\delta} \subset \mathbb{R}^n_{+}$, т.е. то, сколько токенов предоставил пользователь в пул ликвидности в процессе торговли. Третий аргумент представляет собой вектор выходов $\mathbf{\lambda} \subset \mathbb{R}^n_{+}$, т.е. то, сколько токенов получит пользователь от пула ликвидности в процессе торговли.
Возвращает функция количество ликвидности после совершения сделки.

Приведем конкретный пример. Пусть задан пул ликвидности Uniswap V3, в нем находятся токены WETH(обернутый Ethereum, ERC-20 адаптация нативного токена сети Ethereum Mainnet) и USDT (Tether USD, стейблкоин, чья стоимость примерно равна одному доллару США). В случае Uniswap V3, количество токенов в пуле $n = 2$

Эти токены находятся в пуле в определенном количестве, и это количество задает вектор резервов, например: $\mathbf{R} = \{1, 2000\}$. В пуле находятся 2000 USDT и 1 WETH.
Векторы $\delta$ и $\lambda$ задают т.н. сделку, которая состоит из вектора входов и вектора выходов. Например, если пользователь хочет купить WETH, предоставив 300 USDT, то эта сделка будет выглядеть так: предоставление 300 USDT $\delta = \{0, 300\}$ и получение взамен 0.1304 WETH $\lambda = \{0, 0.1304\}$

Почему именно 0.1304 WETH? Дело в том, что на функцию $\varphi$ накладывается важное ограничение, которое и называется постоянным произведения (constant product). Сделка $(\delta, \lambda)$ считается валидной, если

\begin{equation}
	\varphi(R, \delta, \lambda) = \varphi(R, \mathbf{0}, \mathbf{0})  \label{eq:trade_fn_valid_criterion}
\end{equation}

Иными словами, сделка считается валидной, если общее количество ликвидности не меняется после совершения сделки. В нашем примере со сделкой покупки WETH за 300 USDT, количество WETH, которое получит пользователь, задается именно этим правилом.

Важное замечание заключается в том, что на практике это условие не соблюдается, и небольшие отклонения возникают вследствие несовершенства представления действительных чисел в любой вычислительной системе. Другой важной причиной нестрогого соблюдения это условия является так называемое проскальзывание, которое возникает в Uniswap V3, в протоколе, который рассматривается в первую очередь в данной работе.

\section{Задание функции торговли}
Чтобы определять, сколько пользователь получит токенов в результате совершения сделки, нужно задать функцию торговли.

Функция торговли для Uniswap V3 выглядит следующим образом

\begin{equation}
	\varphi(R, \delta, \lambda) = (R_1 + \delta_1 - \lambda_1) \cdot (R_2 + \delta_2 - \lambda_2)
	\label{eq:trade_fn_uniswapv3}
\end{equation}

где
\begin{enumerate}
	\item $R_1$ и $R_2$ представляют собой компоненты вектора резервов $\mathbf{R}$, количество токенов WETH и USDT в пуле соответственно;
	\item $\delta_1$ и $\delta_2$ представляют собой количество WETH и USDT, которые пользователь предоставляет в пул в процессе сделки;
	\item $\lambda_1$ и $\lambda_2$ представляют собой количество WETH и USDT, которые пользователь получит в результате сделки.
\end{enumerate}

В случае Uniswap V3 можно считать, что $\delta_1$ и $\delta_2$, равно как и $\lambda_1$ и $\lambda_2$ не могут быть одновременно ненулевыми.
Для целого ряда сделок вида "пользователь предоставляет USDT взамен на WETH" мы можем упростить функцию торговли:

\begin{equation}
	\varphi(R, \delta, \lambda) = (R_1 - \lambda_1) \cdot (R_2 + \delta_2)
	\label{eq:trade_fn_uniswapv3_simplified}
\end{equation}

В рамках таких сделок количество токена с индексом $1$ (WETH) уменьшается на $\lambda_1$, а количество токена с индексом $2$ (USDT) увеличивается на $\delta_2$.

\section{Пример сделки}
Стоит вернуться к примеру сделки, где пользователь покупает WETH за 300 USDT.
До сделки количество ликвидности в пуле составляет:

\begin{equation}
	\varphi(R, \mathbf{0}, \mathbf{0}) = (1 - 0) \cdot (2000 + 0) = 2000
	\label{eq5}
\end{equation}

После сделки, согласно $\eqref{eq:trade_fn_valid_criterion}$, количество ликвидности должно остаться также $2000$.
Подставим в $\eqref{eq:trade_fn_uniswapv3_simplified}$ количество предоставляемых пользователем токенов USDT: $\delta_2 = 300$ и получим количество WETH $\lambda_1$, которые пользователь получит взамен:

\begin{equation}
	\begin{gathered}
		\varphi(R, \delta, \lambda) = (R_1 - \lambda_1) \cdot (R_2 + 300) = 2000
		\\
		(1 - \lambda_1) \cdot (2000 + 300) = 2000
		\\
		\lambda_1 = 1 - \frac{2000}{2300}
		\\
		\lambda_1 = 0.1304
	\end{gathered}
\end{equation}

\section{Позиция поставщика ликвидности в Uniswap V3}
Данная работа детально рассматривает особенности работы протокола Uniswap третьей версии, поэтому стоит развить мысль о том, что такое позиция поставщика ликвидности (Liquidity provision position). Позиция поставщика ликвидности в Uniswap V3 определяется тремя параметрами:

\begin{enumerate}
	\item Количество ликвидности $L \in \mathbb{R}_+$
	\item Нижняя граница  цены $p_a$
	\item Верхняя граница цены $p_b$
\end{enumerate}

Таким образом, позиция $P$ представляет собой структуру из $(L, p_a, p_b)$.

Позиция активна (также это свойство называется более близким к традиционным финансам In the money, англ. <<в деньгах>>) если текущая цена $p \in (p_a; p_b)$.

Когда позиция активна, поставщик ликвидности получает комиссию за предоставление ликвидности. Размер комиссии определяется самим пулом.
В Uniswap V3 размер комиссии в пуле зависит от <<природы>> токенов, которые в нем участвуют.

Если оба токена являются стейблкоинами одной фиатной валюты (например, доллар США), то такой пул называют пулом стабильной пары (stable pool). В таком пуле комиссии, как правило, небольшие и составляют $0.01\%$, $0.05\%$. Комиссия списывается с каждой сделки обмена в том токене, который пользователь отдаёт при обмене в Uniswap V3.

\subsection{Виртуальные и реальные резервы}

Для позиций в UniswapV3 вводятся понятия виртуальных и реальных резервов. Пусть:

\begin{itemize}
	\item $x_r, y_r$ -- реальные резервы токенов в позиции
	\item $x_v, y_v$ -- виртуальные резервы, соответствующие полному диапазону $(0, \infty)$
	\item $p$ -- текущая цена
	\item $p_a$ -- цена нижней границы
	\item $p_b$ -- цена верхней границы
\end{itemize}

Идею о виртуальных и реальных резервах проще представить в виде такого графика:

\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=\textwidth]{Chapter1-virtual-and-real-reserves.pdf}
		\caption{Представление идеи о виртуальных и реальных резервах. Две точки $a$ и $b$ символизируют на параболе точки, где цена составляет $p_a$ и $p_b$ соответственно. Точка $m$ представляет собой состояние пула ликвидности в настоящий момент времени. Исходя из того, что точка $m$ лежит <<между>> точками $a$ и $b$, можно сделать вывод о том, что эта позиция ликвидности является активной.}
		\label{figure:virtual_real_reserves}
	\end{center}
\end{figure}

На графике приведена ситуация, когда в пуле есть всего одна позиция провайдера ликвидности, и она в момент исполнения сделки является активной.
В данном примере на графике масштаб не приведен, поэтому пропорции не соблюдаются; в реальном случае если в пуле существует только одна позиция провайдера ликвидности, то $x_{real} = x_{virtual}$ равно как и $y_{real} = y_{virtual}$.

График схематично показывает геометрический смысл понятий виртуальной ликвидности и реальной ликвидности.
Виртуальная ликвидность показывает, сколько было бы токенов $x$ и $y$ доступно для обмена в состоянии точки $m$, если бы вся ликвидность пула была бы активной.

Реальная ликвидность показывает, сколько нужно <<потратить>> токенов $x$ или $y$ (в зависимости от того, какой токен пул <<отдает>> пользователю в рамках обмена токенов), чтобы <<выйти>> из позиции провайдера ликвидности. Можно представить, что точка текущего состояния пула $m$ <<идет>> вверх или вниз в зависимости от того, какой токен предоставляется пользователем и какой токен отдается пулом.

Требуется более формально задать виртуальную и реальную ликвидность. Проблема заключается в том, что в данной работе до сих пор не было представлено понятие о ликвидности как величине в протоколе UniswapV3.

\subsection{Понятие ликвидности в UniswapV3}

В UniswapV3 для упрощения вычислений (в частности, виртуальная машина Ethereum (EVM) не поддерживает извлечение корня) де-факто используется не $xy$, а $\sqrt{xy}$. Но для упрощения повествования понятие ликвидности будет в себя включать и $xy$, и $\sqrt{xy}$. В местах, где эта разница имеет значение, ликвидность будет явно описана через формулу. Традиционно в работах и статьях по UniswapV3 $L=\sqrt{xy}$, и $L^2=\sqrt{xy}$.

Функция торговли $\varphi$, заданная в $\eqref{eq:trade_fn_uniswapv3_simplified}$, задает как раз значение $L^2$. Перефразируя, получим более "UniswapV3-like" выражение:

\begin{equation}
	L^2 = (R_1 - \lambda_1) \cdot (R_2 + \delta_2)
\end{equation}

Если приравнять $\lambda_1 = 0$ и $\delta_2 = 0$, то получается функция исключительно от $R_1$ и $R_2$:


\begin{equation}
	L^2 = (R_1) \cdot (R_2)
	\label{eq:liquidity_function_uniswapv3_cfmm}
\end{equation}

В примере с графиком резервы назывались $x$ и $y$, разумеется, $x = R_1$ и $y = R_2$. Теперь возможно описать позицию провайдера ликвидности с точки зрения CPMM-терминов, что позволит более строго определить понятие виртуальной и реальной ликвидности.

Виртуальные резервы представляют собой вектор $(R_{1_{virtual}}, R_{2_{virtual}})$. Это резервы, которые используются для вычисления текущей цены активов в пуле. Именно эту цену видит конечный пользователь, который приходит на платформу UniswapV3 с целью обменять одни токены на другие.

\begin{equation}
	\begin{gathered}
		L = R_{1_{virtual}} \cdot \sqrt{p}
		\\
		R_{1_{virtual}} = \frac{L}{\sqrt{p}}
		\label{eq:virtual_liquidity_r_1}
	\end{gathered}
\end{equation}

\begin{equation}
	\begin{gathered}
		L = \frac{R_{2_{virtual}}}{\sqrt{p}}
		R_{2_{virtual}} = L \cdot \sqrt{p}
		\label{eq:virtual_liquidity_r_2}
	\end{gathered}
\end{equation}

Реальные резервы можно выразить из ликвидности, которая была активна во время сделки.

\begin{equation}
	R_{1_{real}} = \frac{1}{\sqrt{p}} \cdot \sum_{i}{L_i}
	\label{eq:real_liquidity_r_1}
\end{equation}

\begin{equation}
	R_{2_{real}} = \sqrt{p} \cdot \sum_{i}{L_i}
	\label{eq:real_liquidity_r_2}
\end{equation}

Сумма $L_i$ берется по всем активным в момент исполнения сделки позициям $P_i = (L_i, p_{i_{lower}}, p_{i_{upper}})$ поставщика ликвидности.
Более формально условие для того, чтобы $P_i$ считалась активной, выглядит так: $p_{i_{lower}} \leq p \leq p_{i_{upper}}$.

\section{Торговое множество и достижимость сделки}

Следующее развитие мысли -- введение понятия торгового множества $T$, которое представляет собой множество сделок, доступных в конкретный момент времени (точнее, для конкретного набора резервов токенов $\mathbf{R}$)

\begin{equation}
	T(\mathbf{R}) = \{(\delta, \lambda) | \varphi(\mathbf{R}, \delta', \lambda') = \varphi(R, \mathbf{0}, \mathbf{0}) \}
	\label{eq:trading_set}
\end{equation}

где сделка $(\delta', \lambda')$ -- произвольная сделка, которая "выгоднее" для пользователя, чем сделка $(\delta, \lambda)$, которая попадает в множество доступных сделок $T(R)$.
Под "выгодностью" сделки понимается, что $\delta' \leq \delta$, а $\lambda' \geq \lambda$, т.е. в пересчете на одну единицу предоставляемых пользователем токенов $\delta$ пользователь получит больше токенов $\lambda$.

Само определение торгового множества в некотором смысле проистекает из критерия валидности сделки из \ref{eq:trade_fn_valid_criterion}.
Таким образом, торговое множество состоит из таких сделок, для которых точно есть более выгодная альтернатива при текущих резервах $\mathbf{R}$. Торговое множество определяет все возможные, пусть даже в том числе и экономически бессмысленные сделки.


\section{Торговое множество в UniswapV3}

Особенности протокола UniswapV3 отражаются и на том, как задается торговое множество. Определение выше является общим понятием для самых разных алгоритмов CFMM; однако, для изучения работы UniswapV3 требуется уточнить это определение.

Сделки можно разделить на те, что сохраняют цену активов в пуле (обычно это небольшие по объему сделки), и на те, что меняют текущую цену активов пула.
Очень большие сделки могут значительно сместить цену активов; это одна из ключевых особенностей работы CFMM.

Для сделок, которые не изменяют цену, торговое множество задается следующим образом:

\begin{equation}
	T_{within}(R_1, R_2) = \{ (\delta, \lambda): \varphi(R, \delta', \lambda') = \varphi(R, 0, 0) \}
	\label{eq:trading_set_uniswapv3_within_tick}
\end{equation}
где $\varphi(R, \delta, \lambda) = (R_1 + \delta) \cdot (R_2 - \lambda)$.
Как и было описано выше, $(\delta', \lambda')$ -- более выгодная сделка, $\delta' \leq \delta$, а $\lambda' \geq \lambda$.

Также можно говорить, что такие сделки <<не сдвигают тик>>, но о тиках в UniswapV3 в данной работе будет сказано позднее.

Сделки, которые меняют цену, представляют собой более сложную структуру. По факту, из-за того, что они меняют цену, такие сделки можно представить как композицию двух сделок: одна сделка по старой цене, другая по новой. Идея проста: цена меняется из-за того, что для текущей цены недостаточно ликвидности, поэтому цена переходит в другое значение, в котором становятся активными уже другие позиции поставщиков ликвидности. Какая-то часть этой большой сделки выполнилась по прежней цене (пока хватало ликвидности), остальная часть была исполнена по новой цене.

% TODO: formula for through trading set

$$T_{through}(R) = \{(\delta, \lambda) : \}$$


\section{Независимость торговых путей}
Важно сделать несколько упрощений модели работы CFMM, которые сделают моделирование процессов менее громоздкими. Для этого важно ввести понятие торгового пути (trading path).

Пусть изначально пул CFMM находится в состоянии $\mathbf{R}^0$.
После первой сделки он станет $\mathbf{R}^1$, после второй -- $\mathbf{R}^2$ и так далее до $\mathbf{R}^m$, где $m \in \mathbb{Z}_{+}$.

Последовательность $\{\mathbf{R}^{i}\}^{m}_{i = 0}$ является торговым путем, если эти состояния последовательно достигаются после совершения сделок $\{(\delta, \lambda)^{i}\}^{m}_{i = 0}$.
Последовательность сделок $(\delta, \lambda)^i$ является торговой стратегией.

Независимостью торговых путей является свойство CFMM, при котором можно прийти сразу в состояние $\mathbf{R}^m$, совершив одну большую <<суммарную>> сделку, вместо совершения $m$ сделок из стратегии $\{(\delta, \lambda)^{i}\}^{m}_{i = 0}$.
Формально это выражается таким свойством:

\begin{equation}
	\{R^{i+1} = R^{i} + \delta^i - \lambda^i\}, \quad i = 0, \ldots, m \\
	\label{eq:trading_path_indenpence_part_1}
\end{equation}

Равняется

\begin{equation}
	R + \sum_{i = 0}^{m}{\delta^i} - \sum_{i = 0}^{m}{\lambda^i}
	\label{eq:trading_path_independence_part_2}
\end{equation}

Схематично это можно изобразить следующим образом:
\begin{figure}[!h]
	\begin{center}
		\includegraphics[width=\textwidth]{Chapter1-path-independence.pdf}
		\caption{Демонстрация независимости торговых путей в CFMM. Торговый путь, выраженный сплошными и пунктирными стрелками приведет в ту же точку $\mathbf{R}^m$, что и торговый путь, состоящий из единственной верхней стрелки, состоящей из точек и пунктира.}
		\label{figure:path_independence_demo}
	\end{center}
\end{figure}


\section{Несовершенство торговых путей}
Следующее, расширяющее эту идею понятие -- несовершенство торговых путей (trade path deficiency).
В CFMM произвольный торговый путь является несовершенным, если:

\begin{equation}
	\forall \mathbf{R}, \forall \mathbf{R}' \in S(\mathbf{R}) \; \exists S(\mathbf{R'})\: S(\mathbf{R'}) \subseteq S(\mathbf{R})
	\label{eq:trading_path_deficiency}
\end{equation}

где $\mathbf{R}$ -- текущее состояние пула CFMM, $S(\mathbf{R})$ -- множество достижимых резервов из состояния $\mathbf{R}$.

Важным для дальнейшей работы является следствие о том, что резервы в пуле, вне зависимости от количества проведенных сделок, будут ограничены снизу:
\begin{equation}
	\forall n \in \mathbb{N}: \; \mathbf{1}^T \cdot \mathbf{R^n} \geq \inf \mathbf{1}^T \cdot \mathbf{R^0}
	\label{eq:trade_fn_general_inf}
\end{equation}
где $\mathbf{R^n}$ -- состояние пула CFMM после $n$ совершенных сделок. $\mathbf(R^0)$ соответственно означает начальное состояние пула.

\section{Сравнительный анализ Uniswap V2 и Uniswap V3 с точки зрения несовершенства торговых путей}
Важное изменение между Uniswap V2 и Uniswap V3 заключается во внедрении диапазонов действия ликвидности. В Uniswap V2 ликвидность предоставлялась на весь диапазон цены, т.е. на $[0; \infty)$. В Uniswap V3 при предоставлении ликвидности пользователь указывает также диапазон цены, в котором его ликвидность будет функционировать. В данной работе этот вопрос будет рассмотрен более детально в следующей главе, а пока следует указать, что формальное определение, данное в формуле (\ref{eq:trading_path_deficiency}), на практике означает, что последовательность сделок теперь имеет значение.

В Uniswap V2, где функция торговли является <<чистым>> CPMM, маркетмейкером постоянного произведения, конечное состояние пула $R^m$ зависит только от чистого потока токенов, как показано в (\ref{eq:trading_path_independence_part_2}). Торговые пути независимы в Uniswap V2.
В Uniswap V3, т.е. с концентрированной ликвидностью, конечное состояние пула $\mathbf{R}^m$ зависит от конкретной последовательности цен, по которым проходили сделки. Это связано с тем, что активные резервы в пуле V3 определяются текущей ценой. Когда цена выходит за пределы диапазона $[P_a, P_b]$ конкретной позиции ликвидности, эта позиция <<деактивируется>> и перестает участвовать в торговле. Таким образом, множество достижимых состояний $S(\mathbf{R})$ динамически меняется с каждым ценовым движением. Свойство \eqref{eq:trading_path_deficiency} как раз говорит о том, что множество достижимых состояний может только сужаться.

Пока цена находится в диапазоне цены, заданном при создании позиции ликвидности, Uniswap V3 ведет себя почти также, как и Uniswap V2. Как только сделка (или серия сделок) сдвигает цену так, что\ покидает текущий активный диапазон $[P_a, P_b]$ и пересекает границу $P_a$ или $P_b$, применимо свойство несовершенства торговых путей.

При этом обычно, когда позиция ликвидности деактивируется, это означает потенциально меньший диапазон возможных состояний пула, особенно когда цена в процессе исполнения сделки <<уходит>> от рыночной (поскольку большинство остальных пользователей скорее всего предоставили ликвидность в окрестность точки рыночной цены), тем самым выполняется свойство \ref{eq:trading_path_deficiency}: $S(\mathbf{R'}) \subseteq S(\mathbf{R})$

\section{Цели и задачи магистерской работы}

\textbf{Цель работы} -- Изучение влияния институциональных участников рынка предоставления ликвидности, и следующая из этого проверка гипотезы о том, что институциональные игроки почти всегда опережают обычных пользователей в доходах на рынке предоставления ликвидности протокола UniswapV3. Принято считать, что институциональные участники активнее управляют своей ликвидностью, размещают ликвидность в более узких ценовых диапазонах, они лучше знают движения стоимости тех или иных активов, что позволяет им точнее решать задачу арбитража, что также влияет на доход поставщиков ликвидности, они работают со значительными денежными объемами, что позволяет им более агрессивно вести себя в пулах ликвидности со стейблкоинами. Эти предпосылки теоретически дают институциональным участникам преимущество. Эти гипотезы а также статьи, в которых они были выдвинуты, будут рассмотрены подробнее в данной работе. В работе сперва будет приведено теоретическое обоснование тех или иных преимуществ институциональных участников, а затем на собранных данных из блокчейна Ethereum будет сформирован датасет и проведен анализ данных. Полученная картина позволит оценить влияние институциональных участников рынка предоставления ликвидности протокола UniswapV3.

\textbf{Задачи работы:}
\begin{enumerate}
	\item 
	\item not done.
	\item not done.
	\item not done.
\end{enumerate}
